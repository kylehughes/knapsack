#!/usr/bin/env zsh
#===============================================================================
#  tmux-pane-name â€” Generate AI-powered name for a tmux pane
#
#  USAGE:
#    tmux-pane-name [pane-id]       Name specific pane (default: current)
#    tmux-pane-name -f [pane-id]    Force update, skip debounce
#    tmux-pane-name --sync          Run synchronously (block until complete)
#
#  REQUIREMENTS:
#    zsh >= 4.x, tmux, claude CLI
#
#  EXIT CODES:
#    0  success (or update queued in background)
#    1  not in tmux / invalid pane
#    2  debounce skipped update
#    3  lock held by another process
#
#  AUTHOR:      Kyle Hughes <kyle@kylehugh.es>
#  LICENSE:     MIT
#===============================================================================

# --- Argument Parsing ---

local force=false
local sync=false
local pane_id=""

while [[ $# -gt 0 ]]; do
    case "$1" in
        -f|--force) force=true; shift ;;
        --sync) sync=true; shift ;;
        -*) echo "Unknown option: $1" >&2; return 1 ;;
        *) pane_id="$1"; shift ;;
    esac
done

# --- Environment Check ---

# Verify we're in tmux.
if [[ -z "$TMUX" ]]; then
    echo "Error: Not in a tmux session" >&2
    return 1
fi

# Default to current pane if not specified.
pane_id="${pane_id:-$(tmux display-message -p '#{pane_id}')}"

# --- Debounce Logic ---

local state_dir="${TMPDIR:-/tmp}/tmux-pane-names"
local safe_id="${pane_id//\%/}"
local lock_file="$state_dir/${safe_id}.lock"
local last_file="$state_dir/${safe_id}.last"
local debounce_seconds=2

mkdir -p "$state_dir"

# Skip if recently updated (unless forced).
if [[ "$force" != "true" && -f "$last_file" ]]; then
    local last_update=$(stat -f %m "$last_file" 2>/dev/null || echo 0)
    local now=$(date +%s)
    if (( now - last_update < debounce_seconds )); then
        return 2
    fi
fi

# Acquire lock (directory-based for atomicity).
if ! mkdir "$lock_file" 2>/dev/null; then
    return 3
fi

# --- Context Gathering ---

# Get pane info from tmux in one call.
local pane_info=$(tmux display-message -p -t "$pane_id" \
    '#{pane_current_path}|#{pane_current_command}')
local pane_path="${pane_info%%|*}"
local pane_cmd="${pane_info#*|}"

# Git context (if in a repository).
local git_info=""
if git -C "$pane_path" rev-parse --git-dir &>/dev/null 2>&1; then
    local branch=$(git -C "$pane_path" symbolic-ref --short HEAD 2>/dev/null || echo "detached")
    local repo=$(git -C "$pane_path" rev-parse --show-toplevel 2>/dev/null)
    local repo_name="${repo:t}"
    git_info="$repo_name ($branch)"
fi

# Recent commands (last 3, cleaned up).
local recent_cmds=""
if [[ -f ~/.zsh_history ]]; then
    recent_cmds=$(tail -3 ~/.zsh_history 2>/dev/null | sed 's/^[^;]*;//' | tr '\n' ', ' | sed 's/, $//')
fi

# --- Prompt Construction ---

local prompt="Generate a short (2-5 words) descriptive name for this terminal pane.

Context:
- Directory: $pane_path
- Process: $pane_cmd"

[[ -n "$git_info" ]] && prompt="$prompt
- Git: $git_info"

[[ -n "$recent_cmds" ]] && prompt="$prompt
- Recent: $recent_cmds"

prompt="$prompt

Reply with ONLY the pane name in Title Case, nothing else."

# --- Claude Invocation ---

_tmux_pane_name_invoke() {
    local pane_id="$1"
    local prompt="$2"
    local lock_file="$3"
    local last_file="$4"

    # Call Claude with timeout.
    local name=$(timeout 30 claude -p "$prompt" --model sonnet 2>/dev/null)

    # Validate response.
    local valid=true
    [[ -z "$name" ]] && valid=false
    [[ ${#name} -gt 50 ]] && valid=false
    [[ "$name" == *Error* ]] && valid=false
    [[ "$name" == *error* ]] && valid=false
    [[ "$name" == *"budget"* ]] && valid=false
    [[ "$name" == *"timeout"* ]] && valid=false

    if [[ "$valid" == "true" ]]; then
        # Clean up any quotes or extra whitespace.
        name="${name//\"/}"
        name="${name//\'/}"
        name="${name#"${name%%[![:space:]]*}"}"
        name="${name%"${name##*[![:space:]]}"}"

        # Update pane title.
        tmux select-pane -t "$pane_id" -T "$name"
    fi

    # Update timestamp and release lock.
    touch "$last_file"
    rmdir "$lock_file" 2>/dev/null
}

if [[ "$sync" == "true" ]]; then
    # Synchronous mode: block until complete.
    _tmux_pane_name_invoke "$pane_id" "$prompt" "$lock_file" "$last_file"
else
    # Async mode: run in background and disown.
    _tmux_pane_name_invoke "$pane_id" "$prompt" "$lock_file" "$last_file" &!
fi
