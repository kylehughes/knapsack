# zsh configuration

# --- Security ---

# New files readable only by owner (rw-------).
umask 077

# Automatically remove duplicate entries from PATH.
typeset -U path

# --- History ---

HISTFILE=~/.zsh_history
HISTSIZE=10000
SAVEHIST=10000
setopt APPEND_HISTORY
setopt SHARE_HISTORY
setopt HIST_FIND_NO_DUPS
setopt HIST_IGNORE_DUPS
setopt HIST_REDUCE_BLANKS
setopt HIST_VERIFY
setopt HIST_IGNORE_SPACE         # Commands starting with space not recorded.
setopt HIST_NO_STORE             # Don't store 'history' command itself.
setopt HIST_EXPIRE_DUPS_FIRST    # Expire duplicates first when trimming.

# Protect history file permissions.
[[ -f "$HISTFILE" ]] && chmod 600 "$HISTFILE"

# --- Navigation ---

setopt AUTO_CD              # cd by typing directory name alone.
setopt AUTO_PUSHD           # Push directories to stack automatically.
setopt PUSHD_IGNORE_DUPS
setopt PUSHD_SILENT

# --- Completion ---

# Cache completions and only regenerate once per day.
autoload -Uz compinit
if [[ -n ~/.zcompdump(#qN.mh+24) ]]; then
    compinit
else
    compinit -C
fi
zstyle ':completion:*' menu select
zstyle ':completion:*' matcher-list 'm:{a-z}={A-Z}'    # Case-insensitive matching.
zstyle ':completion:*' list-colors ''
setopt COMPLETE_IN_WORD
setopt ALWAYS_TO_END

# --- Key Bindings ---

bindkey -e  # Emacs mode.
bindkey '^[[A' history-search-backward
bindkey '^[[B' history-search-forward

# Bracketed paste prevents shell interpretation during paste.
autoload -Uz bracketed-paste-magic
zle -N bracketed-paste bracketed-paste-magic

# --- Theme ---

# Gengar theme colors.
GENGAR_PURPLE='%F{135}'      # Medium purple.
GENGAR_BRIGHT='%F{177}'      # Bright purple/pink.
GENGAR_WHITE='%F{255}'       # Almost white for contrast.

# Display git branch in prompt.
git_branch() {
    local branch=$(git symbolic-ref --short HEAD 2>/dev/null)
    if [[ -n $branch ]]; then
        echo "${GENGAR_BRIGHT}git:${GENGAR_WHITE}$branch%f "
    fi
}

setopt PROMPT_SUBST

# Gengar-themed prompt.
PROMPT='${GENGAR_PURPLE}%1~%f $(git_branch)${GENGAR_WHITE}%#%f '

# --- Aliases ---

# Git shortcuts.
alias g='git'
alias ga='git add'
alias gaa='git add --all'
alias gb='git branch'
alias gc='git commit -v'
alias gca='git commit -v -a'
alias gcam='git commit -a -m'
alias gco='git checkout'
alias gd='git diff'
alias gf='git fetch'
alias gl='git pull'
alias glog='git log --oneline --decorate --graph'
alias gp='git push'
alias gr='git remote'
alias gst='git status'

# Directory listing.
alias ll='ls -la'
alias la='ls -A'
alias l='ls -CF'

# Prevent URL interpretation in network commands.
alias curl='noglob curl'
alias wget='noglob wget'
alias scp='noglob scp'

# --- Environment ---

export EDITOR='vim'
export LANG=en_US.UTF-8

# --- Functions ---

# Add functions directory to fpath for autoloading.
fpath=(~/.config/zsh/functions $fpath)

# Autoload all executable functions.
for func in ~/.config/zsh/functions/*(N-.x:t); do
    autoload -Uz $func
done

# Add local functions directory if it exists.
if [[ -d ~/.config/zsh/functions-local ]]; then
    fpath=(~/.config/zsh/functions-local $fpath)
    for func in ~/.config/zsh/functions-local/*(N-.x:t); do
        autoload -Uz $func
    done
fi

# --- PATH Management ---

# Homebrew (Apple Silicon).
if [[ -f /opt/homebrew/bin/brew ]]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi

# Version management (mise) - unified node/ruby/python.
if command -v mise &> /dev/null; then
    eval "$(mise activate zsh)"
fi

# Directory environment management.
if command -v direnv &> /dev/null; then
    eval "$(direnv hook zsh)"
fi

# Add custom bin directory.
export PATH="$HOME/bin:$PATH"

# Rust (Cargo).
if [[ -d "$HOME/.cargo/bin" ]]; then
    export PATH="$PATH:$HOME/.cargo/bin"
fi

# LM Studio CLI tools.
if [[ -d "$HOME/.lmstudio/bin" ]]; then
    export PATH="$PATH:$HOME/.lmstudio/bin"
fi

# --- Additional Configurations ---

# Source local profile if it exists.
[[ -f ~/.profile ]] && source ~/.profile

# Disable git globbing for commands like 'git add *'.
alias git='noglob git'

# Secure ShellFish iOS terminal integration (clipboard, widgets, notifications).
[[ -f ~/.shellfishrc ]] && source ~/.shellfishrc

